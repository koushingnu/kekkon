# LINE問い合わせシステム 仕様書

## 1. システム概要

LINEを通じて問い合わせを受け付け、電話番号を含むメッセージを検出した場合に確認を行い、承認された場合はメールで通知するシステムです。

## 2. 基本機能

1. メッセージの受信（LINE Webhook）
2. 電話番号の検出と検証
3. 確認メッセージの表示（Flexメッセージ）
4. メール通知（承認時）
5. メッセージ履歴の管理

## 3. 詳細仕様

### 3.1 メッセージ形式

必要な入力形式：

```
【お名前】山田太郎
【電話番号】090-1234-5678
```

### 3.2 電話番号の検証

有効な電話番号形式：

#### 携帯電話

- `090-1234-5678`（ハイフンあり）
- `09012345678`（ハイフンなし）
- `０９０１２３４５６７８`（全角数字も可）

#### 固定電話

- 市外局番2桁: `03-1234-5678`
- 市外局番3桁: `045-123-4567`
- 市外局番4桁: `0467-12-3456`

### 3.3 確認メッセージ

電話番号が検出された場合、以下の確認メッセージを表示：

1. ヘッダー画像
2. タイトル「専門スタッフからご連絡」
3. 説明文「最短当日、専門スタッフからご連絡してもよろしいでしょうか？」
4. 選択肢
   - 「はい、大丈夫です」
   - 「いいえ、結構です」

### 3.4 応答メッセージ

#### 承認時（「はい、大丈夫です」）

```
ありがとうございます。
専門スタッフよりご連絡させていただきます。
しばらくお待ちください。
```

#### 拒否時（「いいえ、結構です」）

```
承知いたしました！気になる点がありましたら、いつでもお気軽にお問合せください
```

#### 無効な電話番号形式の場合

```
申し訳ありません。電話番号の形式が正しくないようです。

以下のような形式で電話番号を入力してください：
・携帯電話の場合：090-1234-5678
・固定電話の場合：03-1234-5678
```

#### 入力形式が異なる場合

```
以下の形式で入力してください：

【お名前】山田太郎
【電話番号】090-1234-5678
```

### 3.5 メール通知

承認された場合、以下の形式でメールを送信：

- 件名: `LINE問い合わせ【フレッツ光でグッドライフ】flets_line`
- 本文:

  ```
  [ID] : {ユーザーID}

  === メッセージ履歴 ===
  [タイムスタンプ]
  メッセージ内容
  [タイムスタンプ]
  メッセージ内容
  ...
  ```

### 3.6 データ管理

- メッセージ履歴: `Map<userId, { text: string; timestamp: string }[]>`
- 承認待ち: `Map<userId, { text: string; timestamp: string }>`

## 4. 技術仕様

### 4.1 使用技術

- Node.js/TypeScript
- Express（Webサーバー）
- @line/bot-sdk（LINE Messaging API）
- nodemailer（メール送信）
- dotenv（環境変数管理）

### 4.2 環境変数

```
LINE_CHANNEL_SECRET=【設定済み】
LINE_ACCESS_TOKEN=【設定済み】
PORT=3000
GMAIL_USER=【設定済み】
GMAIL_APP_PASSWORD=【設定済み】
MAIL_TO=koushin1022apple@gmail.com,qsu3he-00001-flets@hdpeach.htdb.jp
```

### 4.3 依存関係

```json
{
  "dependencies": {
    "@line/bot-sdk": "^10.2.0",
    "dotenv": "^17.2.2",
    "express": "^5.1.0",
    "nodemailer": "^6.9.14"
  },
  "devDependencies": {
    "@types/express": "^5.0.3",
    "@types/node": "^24.3.1",
    "tsx": "^4.20.5",
    "typescript": "^5.9.2"
  }
}
```

## 5. セキュリティ

1. LINE Webhookの署名検証
2. 環境変数による機密情報の管理
3. メール送信時のアプリパスワード使用

## 6. 制限事項

1. メッセージ履歴はメモリ上で管理（サーバー再起動で消失）
2. 電話番号の重複チェックなし
3. 承認待ち状態のタイムアウト処理なし
